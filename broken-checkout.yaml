apiVersion: v1
kind: ConfigMap
metadata:
  name: broken-checkout-script
  namespace: monitoring
data:
  app.py: |
    import time
    import random
    import logging
    import os
    from opentelemetry import trace
    from opentelemetry.sdk.trace import TracerProvider
    from opentelemetry.sdk.trace.export import BatchSpanProcessor
    from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
    from opentelemetry.sdk.resources import Resource

    # Setup OTel
    resource = Resource.create({"service.name": "checkout-service"})
    provider = TracerProvider(resource=resource)
    exporter = OTLPSpanExporter(endpoint="tempo.monitoring.svc.cluster.local:4317", insecure=True)
    provider.add_span_processor(BatchSpanProcessor(exporter))
    trace.set_tracer_provider(provider)
    tracer = trace.get_tracer(__name__)

    # Setup Logging
    logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(message)s')
    logger = logging.getLogger(__name__)

    logger.info("Starting Checkout Service...")

    while True:
        with tracer.start_as_current_span("process_checkout") as span:
            trace_id = format(span.get_span_context().trace_id, "032x")
            
            # Simulate work
            time.sleep(random.uniform(0.1, 0.5))
            
            # 30% chance of failure
            if random.random() < 0.3:
                span.set_attribute("error", True)
                span.record_exception(Exception("Payment Gateway Timeout"))
                logger.error(f"Payment failed! DB connection timed out. traceID={trace_id}")
            else:
                logger.info(f"Order processed successfully. traceID={trace_id}")
                
        time.sleep(2)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: broken-checkout
  namespace: monitoring
  labels:
    app: broken-checkout
    app.kubernetes.io/name: broken-checkout
    app.kubernetes.io/instance: broken-checkout
spec:
  replicas: 1
  selector:
    matchLabels:
      app: broken-checkout
  template:
    metadata:
      labels:
        app: broken-checkout
        app.kubernetes.io/name: broken-checkout
        app.kubernetes.io/instance: broken-checkout
    spec:
      containers:
      - name: app
        image: python:3.9-slim
        command: ["/bin/sh", "-c"]
        args:
        - |
          pip install opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp && python /app/app.py
        volumeMounts:
        - name: script
          mountPath: /app
      volumes:
      - name: script
        configMap:
          name: broken-checkout-script
